# 后端开发文档

## 一、总体说明

**项目名称：** 智能语音 AI-Agent 开放平台  
**后端目标：**  
- 构建基于 Node.js + Express 的 RESTful API 后端，为普通用户提供语音全流程交互支持，同时为开发者与管理员提供数据管理接口。
- 初步实现语音文本接收、任务与日志管理，以及开发者服务提交与审核的核心功能。
- 将用户语音指令通过MCP路由功能识别并转发至相应的MCP服务器。
- 返回由MCP服务器（如Minimax）合成的语音URL，使前端能够直接播放响应语音。

**功能概述：**  
- **普通用户端：**  
  - 接收前端传来的语音转文字数据，通过MCP路由确定调用的服务。
  - 支持流式语音交互，能够处理用户停顿和部分输入。
  - 返回语音合成URL供前端播放，提供完整的语音对话体验。
- **开发者模块：**  
  - 提供接口供开发者提交 AI-Agent 对接文档和 API 参数配置，审核后将服务信息纳入平台。
- **管理员模块：**  
  - 提供用户管理、任务与日志查询、系统监控及服务审核接口。

## 二、技术栈

- **开发语言及框架：** Node.js + Express  
- **数据库：** MySQL  
  - 数据库连接方式：mysql://root:pqqczcqx@test-db-mysql.ns-v5wxa09j.svc:3306
- **集成模块：**  
  - 集成大语言模型（LLM）
  - 【已实现】集成 MCP Client 模块用于服务调用，支持各类 MCP 服务的统一接入。
- **安全措施：**  
  - 所有接口均需使用 HTTPS，严格权限验证和数据安全策略。

## 三、功能模块设计

### 1. 语音文本接收模块

- **功能描述**  
  - 接收前端传来的语音转文字数据及用户标识，直接将数据传递给下游。
  - 支持完整语音文本和部分语音文本（用户停顿时）的处理。
  
### 2. LLM 意图和MCP网关路由

- **功能描述：**  
  - 判断用户语音指令对应要调用的MCP服务器。
  - 基于用户的语音内容和上下文智能选择最合适的MCP服务进行调用。
  - 支持多轮对话，维护会话状态和上下文信息。

### 3. MCP 服务调用模块

- **功能描述：【已实现】**  
  - 已实现基于 MCP 协议的客户端，用于调用各类 MCP 服务，具体功能取决于所调用的服务配置。
  - 在关键操作执行前，返回操作摘要，并等待用户确认后再进行调用。
  - 接收MCP服务器返回的语音合成URL，传递给前端进行播放。

- **核心接口：【已实现】**
  - `POST /api/mcp/execute`：
    - 执行 MCP 服务调用，根据用户意图调用相应服务
    - 返回调用结果

- **主要功能特性：【已实现】**
  - 支持丰富的服务能力，可集成各类第三方服务和功能
  - 可扩展的操作类型，根据实际需求可不断增加新的服务类型
  - 通过统一的协议接口调用，实现对多种服务的标准化访问

- **错误处理机制：【已实现】**
  - 通过标准的错误码和错误消息进行异常处理
  - 所有失败的操作都会记录详细日志，包括请求参数、错误原因和时间戳 

### 4. 任务与日志管理模块

- **功能描述：【已实现】**  
  - 记录用户每次交互流程的日志，包括语音文本上传、LLM占位接口调用、关键操作确认和 MCP接口调用。
  - 提供任务状态与日志查询接口 `/api/tasks/:taskId`，便于前端和管理员查询各流程的执行情况。

### 5. 开发者 AI-Agent 管理模块

- **功能描述：**  
  - 提供接口供开发者提交 AI-Agent 对接文档和 API 参数配置。
  - 审核后，将开发者提交的信息纳入平台服务列表，支持版本管理和日志查询。
  - 示例接口：`POST /api/developer/submit`。

### 10. 语音合成管理模块【新增】

- **功能描述：**
  - 从MCP服务器（如Minimax）接收语音合成结果，包括音频URL。
  - 支持不同语音风格和参数的配置。
  - 管理语音合成的缓存和过期策略。
  
- **核心接口：**
  - `GET /api/tts/status/:taskId`：查询语音合成任务状态
  - `GET /api/tts/preferences`：获取用户语音偏好设置
  - `PUT /api/tts/preferences`：更新用户语音偏好设置

## 四、API 接口定义示例

### 1. 语音文本上传接口【已实现】

- **地址：** `POST /api/voice/upload`
- **请求示例：**
  ```json
  {
    "userId": "string",
    "voiceText": "string"
  }
  ```
- **返回示例：**
  ```json
  {
    "status": "success",
    "message": "语音文本上传成功"
  }
  ```

### 2. MCP 服务调用接口【已实现】

- **地址：** `POST /api/mcp/execute`
- **请求示例：** _(示例仅供参考，实际参数取决于调用的服务)_
  ```json
  {
    "userId": "string",
    "operation": "mcp_服务名称",
    "params": {
      "参数1": "值1",
      "参数2": "值2"
    },
    "requireConfirmation": true
  }
  ```
- **返回示例（需确认时）：**
  ```json
  {
    "status": "confirmation_required",
    "operationSummary": "操作摘要描述",
    "confirmationId": "conf-123456"
  }
  ```

### 3. 统一API入口【新增】

#### 3.1 通用格式

所有API请求和响应遵循统一格式规范：

**请求格式：**
- 使用标准HTTP方法（GET, POST, PUT, DELETE）
- 根据请求类型采用URL参数或JSON请求体
- 对于需要认证的API，在Header中传递认证令牌

**响应格式：**
```json
{
  "status": "success|error|waiting",
  "data": {},
  "message": "操作结果描述",
  "timestamp": "2023-04-19T12:34:56.789Z"
}
```

#### 3.2 主要API端点

##### 聊天API
- **地址：** `POST /api/v1/chat`
- **功能：** 处理用户文本查询
- **请求示例：**
  ```json
  {
    "query": "我想查询天气",
    "userId": "user123",
    "sessionId": "session-1234567890",
    "context": {}
  }
  ```
- **成功响应示例：**
  ```json
  {
    "status": "success",
    "data": {
      "taskId": "task-123456",
      "sessionId": "session-1234567890",
      "responseText": "北京今天天气晴朗，温度20-25度",
      "audioUrl": "https://example.com/audio/response.mp3"
    },
    "message": "请求处理成功",
    "timestamp": "2023-04-19T12:34:56.789Z"
  }
  ```

##### 语音API
- **地址：** `POST /api/v1/voice`
- **功能：** 处理用户语音查询
- **请求示例：**
  ```json
  {
    "voiceText": "我想查询天气",
    "userId": "user123",
    "sessionId": "session-1234567890"
  }
  ```
- **成功响应示例：**
  ```json
  {
    "status": "success",
    "data": {
      "taskId": "task-123456",
      "sessionId": "session-1234567890",
      "responseText": "北京今天天气晴朗，温度20-25度",
      "audioUrl": "https://example.com/audio/response.mp3"
    },
    "message": "语音请求处理成功",
    "timestamp": "2023-04-19T12:34:56.789Z"
  }
  ```

##### 服务列表API
- **地址：** `GET /api/v1/services`
- **功能：** 获取所有可用服务
- **成功响应示例：**
  ```json
  {
    "status": "success",
    "data": {
      "servers": [
        {
          "id": "MiniMax",
          "name": "MiniMax API",
          "description": "提供MiniMax大语言模型接口",
          "type": "command"
        },
        {
          "id": "amap-maps",
          "name": "高德地图API",
          "description": "提供高德地图服务和位置信息",
          "type": "command"
        }
      ]
    },
    "message": "获取服务列表成功",
    "timestamp": "2023-04-19T12:34:56.789Z"
  }
  ```

##### MCP服务执行API
- **地址：** `POST /api/v1/mcp/execute`
- **功能：** 直接执行指定MCP服务
- **请求示例：**
  ```json
  {
    "serverId": "MiniMax",
    "query": "翻译：你好，世界",
    "options": {
      "param1": "value1"
    }
  }
  ```
- **成功响应示例：**
  ```json
  {
    "status": "success",
    "data": {
      "result": {
        "text": "Hello, world",
        "audioUrl": "https://example.com/audio/hello_world.mp3"
      }
    },
    "message": "MCP服务执行成功",
    "timestamp": "2023-04-19T12:34:56.789Z"
  }
  ```

## 五、MCP 服务交互流程

```mermaid
sequenceDiagram
    participant 用户
    participant 前端
    participant LLM as 意图解析模块
    participant MCP as MCP 服务调度模块
    participant 服务 as 外部服务

    用户->>前端: 语音输入
    前端->>前端: 转换为文本
    前端->>LLM: 发送文本
    LLM-->>前端: 返回解析后的意图与参数
    
    alt 关键操作需确认
        前端->>用户: 语音回放操作摘要
        用户->>前端: 口头确认
    end
    
    前端->>MCP: 调用MCP执行操作
    MCP->>服务: 调用外部服务
    服务-->>MCP: 返回服务结果
    MCP-->>前端: 返回执行结果
    前端->>用户: 语音反馈操作结果
```

## 六、API 接口详细定义

### 1. 语音文本上传接口【已实现】

- **地址：** `POST /api/voice/upload`
- **请求示例：**
  ```json
  {
    "userId": "string",
    "voiceText": "string"
  }
  ```
- **返回示例：**
  ```json
  {
    "status": "success",
    "message": "语音文本上传成功"
  }
  ```

### 2. MCP 服务调用接口【已实现】

- **地址：** `POST /api/mcp/execute`
- **请求示例：** _(示例仅供参考，实际参数取决于调用的服务)_
  ```json
  {
    "userId": "string",
    "operation": "mcp_服务名称",
    "params": {
      "参数1": "值1",
      "参数2": "值2"
    },
    "requireConfirmation": true
  }
  ```
- **返回示例（需确认时）：**
  ```json
  {
    "status": "confirmation_required",
    "operationSummary": "操作摘要描述",
    "confirmationId": "conf-123456"
  }
  ```

### 5. 部分语音输入处理接口【新增】

- **地址：** `POST /api/voice/partial`
- **请求示例：**
  ```json
  {
    "userId": "string",
    "sessionId": "string",
    "partialText": "string",
    "isFinal": false
  }
  ```
- **返回示例：**
  ```json
  {
    "status": "success",
    "response": {
      "text": "部分响应文本",
      "audioUrl": "https://storage.minimax.chat/audio/partial-12345.mp3",
      "shouldSpeak": true
    }
  }
  ```

### 6. 语音合成URL获取接口【新增】

- **地址：** `GET /api/tts/url`
- **请求示例：**
  ```json
  {
    "text": "要合成语音的文本",
    "voiceStyle": "normal",
    "speed": 1.0
  }
  ```
- **返回示例：**
  ```json
  {
    "status": "success",
    "audioUrl": "https://storage.minimax.chat/audio/tts-12345.mp3",
    "expiresAt": "2023-06-30T15:30:00Z"
  }
  ```

### 7. 用户语音偏好设置接口【新增】

- **地址：** `PUT /api/user/preferences/voice`
- **请求示例：**
  ```json
  {
    "userId": "string",
    "autoTTS": true,
    "voiceStyle": "female",
    "speed": 1.2
  }
  ```
- **返回示例：**
  ```json
  {
    "status": "success",
    "message": "语音偏好设置已更新"
  }
  ```

## 十、流式交互与会话管理【新增】

### 1. 流式语音交互

- **技术选型：**
  - 使用Server-Sent Events (SSE)或WebSocket实现服务器推送能力
  - 支持部分响应的实时推送，在用户停顿时即可提供反馈
  
- **流式响应格式：**
  ```json
  {
    "type": "partial|final",
    "text": "响应文本片段",
    "audioChunkUrl": "https://storage.minimax.chat/audio/chunk-12345.mp3",
    "done": false
  }
  ```

### 2. 会话状态管理

- **会话创建：** `POST /api/session/create`
- **会话更新：** `PUT /api/session/:sessionId`
- **会话状态查询：** `GET /api/session/:sessionId`

- **会话数据结构：**
  ```json
  {
    "sessionId": "string",
    "userId": "string",
    "startTime": "ISO时间字符串",
    "lastInteractionTime": "ISO时间字符串",
    "context": {
      "历史交互": [],
      "用户偏好": {},
      "当前服务": "string"
    },
    "status": "active|pending|completed"
  }
  ```

## 七、对接与集成要求

- **接口联调：**
  - 前端须通过 HTTPS 调用后端 RESTful API，确保请求格式与返回内容符合接口定义。
  - 普通用户交互流程依次调用：语音上传接口 → LLM意图解析（占位）→ 关键操作确认（由前端捕获语音确认结果）→ MCP服务调用。
  - 开发者和管理员数据提交及查询均通过预定 API 完成。
- **日志与任务追踪：**
  - 后端须记录详细的任务日志，支持通过接口查询各流程的执行状态和错误日志。

## 八、测试与部署

- **测试方案：**
  - 为所有接口编写单元测试和集成测试，确保语音上传、意图解析、关键操作确认和MCP调用流程连贯且准确。
- **部署环境：**
  - 后端采用 Docker 容器化部署，并配置 CI/CD 流水线实现持续集成与自动部署。
  - 数据库 MySQL 配置必须保证安全，确保所有访问均通过 HTTPS 和必要身份验证进行。

## 九、文档维护

- **文档与代码同步：**
  - 随着功能实现和修改，及时更新文档，维持文档与实际代码的一致性。
  - 在文档中明确标注功能的实现状态（已实现/开发中/规划中）。
- **版本控制：**
  - 文档采用版本控制，确保团队成员能够跟踪文档变更历史。 
    "params": {
      "参数1": "值1",
      "参数2": "值2"
    },
    "requireConfirmation": true
  }
  ```
- **返回示例（需确认时）：**
  ```json
  {
    "status": "confirmation_required",
    "operationSummary": "操作摘要描述",
    "confirmationId": "conf-123456"
  }
  ```

### 5. 部分语音输入处理接口【新增】

- **地址：** `POST /api/voice/partial`
- **请求示例：**
  ```json
  {
    "userId": "string",
    "sessionId": "string",
    "partialText": "string",
    "isFinal": false
  }
  ```
- **返回示例：**
  ```json
  {
    "status": "success",
    "response": {
      "text": "部分响应文本",
      "audioUrl": "https://storage.minimax.chat/audio/partial-12345.mp3",
      "shouldSpeak": true
    }
  }
  ```

### 6. 语音合成URL获取接口【新增】

- **地址：** `GET /api/tts/url`
- **请求示例：**
  ```json
  {
    "text": "要合成语音的文本",
    "voiceStyle": "normal",
    "speed": 1.0
  }
  ```
- **返回示例：**
  ```json
  {
    "status": "success",
    "audioUrl": "https://storage.minimax.chat/audio/tts-12345.mp3",
    "expiresAt": "2023-06-30T15:30:00Z"
  }
  ```

### 7. 用户语音偏好设置接口【新增】

- **地址：** `PUT /api/user/preferences/voice`
- **请求示例：**
  ```json
  {
    "userId": "string",
    "autoTTS": true,
    "voiceStyle": "female",
    "speed": 1.2
  }
  ```
- **返回示例：**
  ```json
  {
    "status": "success",
    "message": "语音偏好设置已更新"
  }
  ```

## 十、流式交互与会话管理【新增】

### 1. 流式语音交互

- **技术选型：**
  - 使用Server-Sent Events (SSE)或WebSocket实现服务器推送能力
  - 支持部分响应的实时推送，在用户停顿时即可提供反馈
  
- **流式响应格式：**
  ```json
  {
    "type": "partial|final",
    "text": "响应文本片段",
    "audioChunkUrl": "https://storage.minimax.chat/audio/chunk-12345.mp3",
    "done": false
  }
  ```

### 2. 会话状态管理

- **会话创建：** `POST /api/session/create`
- **会话更新：** `PUT /api/session/:sessionId`
- **会话状态查询：** `GET /api/session/:sessionId`

- **会话数据结构：**
  ```json
  {
    "sessionId": "string",
    "userId": "string",
    "startTime": "ISO时间字符串",
    "lastInteractionTime": "ISO时间字符串",
    "context": {
      "历史交互": [],
      "用户偏好": {},
      "当前服务": "string"
    },
    "status": "active|pending|completed"
  }
  ```

## 七、对接与集成要求

- **接口联调：**
  - 前端须通过 HTTPS 调用后端 RESTful API，确保请求格式与返回内容符合接口定义。
  - 普通用户交互流程依次调用：语音上传接口 → LLM意图解析（占位）→ 关键操作确认（由前端捕获语音确认结果）→ MCP服务调用。
  - 开发者和管理员数据提交及查询均通过预定 API 完成。
- **日志与任务追踪：**
  - 后端须记录详细的任务日志，支持通过接口查询各流程的执行状态和错误日志。

## 八、测试与部署

- **测试方案：**
  - 为所有接口编写单元测试和集成测试，确保语音上传、意图解析、关键操作确认和MCP调用流程连贯且准确。
- **部署环境：**
  - 后端采用 Docker 容器化部署，并配置 CI/CD 流水线实现持续集成与自动部署。
  - 数据库 MySQL 配置必须保证安全，确保所有访问均通过 HTTPS 和必要身份验证进行。

## 九、文档维护

- **文档与代码同步：**
  - 随着功能实现和修改，及时更新文档，维持文档与实际代码的一致性。
  - 在文档中明确标注功能的实现状态（已实现/开发中/规划中）。
- **版本控制：**
  - 文档采用版本控制，确保团队成员能够跟踪文档变更历史。 
    "params": {
      "参数1": "值1",
      "参数2": "值2"
    },
    "requireConfirmation": true
  }
  ```
- **返回示例（需确认时）：**
  ```json
  {
    "status": "confirmation_required",
    "operationSummary": "操作摘要描述",
    "confirmationId": "conf-123456"
  }
  ```

### 5. 部分语音输入处理接口【新增】

- **地址：** `POST /api/voice/partial`
- **请求示例：**
  ```json
  {
    "userId": "string",
    "sessionId": "string",
    "partialText": "string",
    "isFinal": false
  }
  ```
- **返回示例：**
  ```json
  {
    "status": "success",
    "response": {
      "text": "部分响应文本",
      "audioUrl": "https://storage.minimax.chat/audio/partial-12345.mp3",
      "shouldSpeak": true
    }
  }
  ```

### 6. 语音合成URL获取接口【新增】

- **地址：** `GET /api/tts/url`
- **请求示例：**
  ```json
  {
    "text": "要合成语音的文本",
    "voiceStyle": "normal",
    "speed": 1.0
  }
  ```
- **返回示例：**
  ```json
  {
    "status": "success",
    "audioUrl": "https://storage.minimax.chat/audio/tts-12345.mp3",
    "expiresAt": "2023-06-30T15:30:00Z"
  }
  ```

### 7. 用户语音偏好设置接口【新增】

- **地址：** `PUT /api/user/preferences/voice`
- **请求示例：**
  ```json
  {
    "userId": "string",
    "autoTTS": true,
    "voiceStyle": "female",
    "speed": 1.2
  }
  ```
- **返回示例：**
  ```json
  {
    "status": "success",
    "message": "语音偏好设置已更新"
  }
  ```

## 十、流式交互与会话管理【新增】

### 1. 流式语音交互

- **技术选型：**
  - 使用Server-Sent Events (SSE)或WebSocket实现服务器推送能力
  - 支持部分响应的实时推送，在用户停顿时即可提供反馈
  
- **流式响应格式：**
  ```json
  {
    "type": "partial|final",
    "text": "响应文本片段",
    "audioChunkUrl": "https://storage.minimax.chat/audio/chunk-12345.mp3",
    "done": false
  }
  ```

### 2. 会话状态管理

- **会话创建：** `POST /api/session/create`
- **会话更新：** `PUT /api/session/:sessionId`
- **会话状态查询：** `GET /api/session/:sessionId`

- **会话数据结构：**
  ```json
  {
    "sessionId": "string",
    "userId": "string",
    "startTime": "ISO时间字符串",
    "lastInteractionTime": "ISO时间字符串",
    "context": {
      "历史交互": [],
      "用户偏好": {},
      "当前服务": "string"
    },
    "status": "active|pending|completed"
  }
  ```

## 七、对接与集成要求

- **接口联调：**
  - 前端须通过 HTTPS 调用后端 RESTful API，确保请求格式与返回内容符合接口定义。
  - 普通用户交互流程依次调用：语音上传接口 → LLM意图解析（占位）→ 关键操作确认（由前端捕获语音确认结果）→ MCP服务调用。
  - 开发者和管理员数据提交及查询均通过预定 API 完成。
- **日志与任务追踪：**
  - 后端须记录详细的任务日志，支持通过接口查询各流程的执行状态和错误日志。

## 八、测试与部署

- **测试方案：**
  - 为所有接口编写单元测试和集成测试，确保语音上传、意图解析、关键操作确认和MCP调用流程连贯且准确。
- **部署环境：**
  - 后端采用 Docker 容器化部署，并配置 CI/CD 流水线实现持续集成与自动部署。
  - 数据库 MySQL 配置必须保证安全，确保所有访问均通过 HTTPS 和必要身份验证进行。

## 九、文档维护

- **文档与代码同步：**
  - 随着功能实现和修改，及时更新文档，维持文档与实际代码的一致性。
  - 在文档中明确标注功能的实现状态（已实现/开发中/规划中）。
- **版本控制：**
  - 文档采用版本控制，确保团队成员能够跟踪文档变更历史。 